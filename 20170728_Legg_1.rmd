---
title: "Lab3_Initial_Legg"
author: "Legg (Ho Man) Yeung"
date: "July 28, 2017"
output: pdf_document
html_document:
  number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
library(moments)
library(psych)
```


```{r}
unem.data = read.csv("UNRATENSA.csv", header = T)
auto.data = read.csv("TOTALNSA.csv", header = T)
```

# EDA

## Data Overview 

```{r}
str(unem.data)
str(auto.data)
```

```{r}
cbind(head(unem.data),tail(unem.data))
```

```{r}
cbind(head(auto.data),tail(auto.data))
```

```{r}
nrow(unem.data) - nrow(auto.data)
```

- Both datasets are time indexed, accompanied with a key variable of interests. With UNRATENSA, the key variable refers to unemployment rate. With TOTALNSA, the key variable refers to car sale. 

- Both time series presents monthly data. UNRATENSA has 834 observations and starts from 1948-01-01. TOTALNSA has 498 observations  and starts from 1976-01-01. Both ends at 2017-06. UNRATENSA has 28 more years, that is 336 more observations than TOTALNSA.

## Time series Overview

### Time plots and Histograms

```{r}
unem.ts = ts(unem.data$UNRATENSA, frequency = 12, start = c(1948,1))
auto.ts = ts(auto.data$TOTALNSA, frequency = 12, start = c(1976,1))
```

```{r}
ts.plot(unem.ts); title("Unemployment Rate 1948-01 to 2017-06"); 
abline(h = mean(unem.ts), col = "red", lty = "dotted")
#abline(lm(unem.ts~time(unem.ts)), lty = "dotted", col = "blue")
```

(persistent)

```{r}
ts.plot(auto.ts); title("Car Sales 1976-01 to 2017-06")
abline(h = mean(auto.ts), col = "red", lty = "dotted")
#abline(lm(auto.ts~time(auto.ts)), lty = "dotted", col = "blue")
```

(A Sharp Spike in 1980s)
(less persistent than employment rate)

```{r}
hist(unem.data$UNRATENSA, main = "distribution of unemployment rate",
     xlab = "Unemployment Rate")

abline(v = mean(unem.data$UNRATENSA), col = "red", lty = "dotdash"
       , lwd = 2)
abline(v = c((mean(unem.data$UNRATENSA) + sd(unem.data$UNRATENSA)),
             (mean(unem.data$UNRATENSA) + 2*sd(unem.data$UNRATENSA)),
             (mean(unem.data$UNRATENSA) + 3*sd(unem.data$UNRATENSA))), 
       col = "red", lty = "dotted", lwd = 1)
abline(v = c((mean(unem.data$UNRATENSA) - sd(unem.data$UNRATENSA)),
             (mean(unem.data$UNRATENSA) - 2*sd(unem.data$UNRATENSA))), 
       col = "red", lty = "dotted", lwd = 1)

abline(v = median(unem.data$UNRATENSA), col = "green", lty = "dotdash"
       , lwd = 2)

legend("topright", c("Mean","Standard Deviations", "Median"), 
       col = c("red","red","green"), 
       lty = c("dotdash", "dotted","dotdash"))
```

```{r}
hist(auto.data$TOTALNSA, main = "distribution of auto sales",
     xlab = "auto sales - thousands of units")

abline(v = mean(auto.data$TOTALNSA), col = "red", lty = "dotdash"
       , lwd = 2)
abline(v = c((mean(auto.data$TOTALNSA) + sd(auto.data$TOTALNSA)),
             (mean(auto.data$TOTALNSA) + 2*sd(auto.data$TOTALNSA)),
             (mean(auto.data$TOTALNSA) + 3*sd(auto.data$TOTALNSA))), 
       col = "red", lty = "dotted", lwd = 1)
abline(v = c((mean(auto.data$TOTALNSA) - sd(auto.data$TOTALNSA)),
             (mean(auto.data$TOTALNSA) - 2*sd(auto.data$TOTALNSA))), 
       col = "red", lty = "dotted", lwd = 1)

abline(v = median(auto.data$TOTALNSA), col = "green", lty = "dotdash"
       , lwd = 2)

legend("topright", c("Mean","Standard Deviations", "Median"), 
       col = c("red","red","green"), 
       lty = c("dotdash", "dotted","dotdash"))
```


```{r}
summary(unem.data$UNRATENSA)
summary(auto.data$TOTALNSA)
moments::kurtosis(unem.data$UNRATENSA)
```

### Trend Examination with Smoothers and Decomposition

```{r}
# Kernel smoothing
unem.k.smooth.widest = ksmooth(time(unem.ts), 
                             unem.ts, kernel = c("normal"), 
                             bandwidth = 10)

unem.k.smooth.wide = ksmooth(time(unem.ts), 
                             unem.ts, kernel = c("normal"), 
                             bandwidth = 4)

unem.k.smooth.narrow = ksmooth(time(unem.ts), 
                               unem.ts, kernel = c("normal"), 
                               bandwidth = 0.5)

# Make plot
plot(unem.ts, col = "gray", ylab = "Unemployment Rate",
     main = "Unemployment Rate - Kernel Smoothed")
lines(unem.k.smooth.widest$x, unem.k.smooth.widest$y, col = "magenta")
lines(unem.k.smooth.wide$x, unem.k.smooth.wide$y, col = "red")
lines(unem.k.smooth.narrow$x, unem.k.smooth.narrow$y, col = "blue")
abline(lm(unem.ts~time(unem.ts)), lty = "dotted", col = "black")
```

```{r}
# Moving Average Filter
unem.ma.smooth.4year = filter(unem.ts, sides = 1, rep(1/60, 60))
unem.ma.smooth.annual = filter(unem.ts, sides = 1, rep(1/12, 12))
unem.ma.smooth.halfyear = filter(unem.ts, sides = 1, rep(1/6, 6))

# Make plot
plot(unem.ts, col = "gray", ylab = "Unemployment Rate",
     main = "Unemployment Rate - Moving Average Filtered")
lines(unem.ma.smooth.4year, col = "magenta")
lines(unem.ma.smooth.annual, col = "red")
lines(unem.ma.smooth.halfyear, col = "blue")
abline(lm(unem.ts~time(unem.ts)), lty = "dotted", col = "black")
```

```{r}
plot(decompose(unem.ts, type = "additive"))
```

(Decomposition Assumption, Findings of Noise of Inconsistent Variance)
(Seasonality is not clear, but clearly not stationary. can be random walk)

```{r}
# Kernel smoothing
auto.k.smooth.widest = ksmooth(time(auto.ts), 
                             auto.ts, kernel = c("normal"), 
                             bandwidth = 10)

auto.k.smooth.wide = ksmooth(time(auto.ts), 
                             auto.ts, kernel = c("normal"), 
                             bandwidth = 4)

auto.k.smooth.narrow = ksmooth(time(auto.ts), 
                               auto.ts, kernel = c("normal"), 
                               bandwidth = 0.5)

# Make plot
plot(auto.ts, col = "gray", ylab = "Auto Sales thousands of units",
     main = "Car Sales - Kernel Smoothed")
lines(auto.k.smooth.widest$x, auto.k.smooth.widest$y, col = "magenta")
lines(auto.k.smooth.wide$x, auto.k.smooth.wide$y, col = "red")
lines(auto.k.smooth.narrow$x, auto.k.smooth.narrow$y, col = "blue")
abline(lm(auto.ts~time(auto.ts)), lty = "dotted", col = "black")
```

```{r}
# Moving Average Filter
auto.ma.smooth.4year = filter(auto.ts, sides = 1, rep(1/60, 60))
auto.ma.smooth.annual = filter(auto.ts, sides = 1, rep(1/12, 12))
auto.ma.smooth.halfyear = filter(auto.ts, sides = 1, rep(1/6, 6))

# Make plot
plot(auto.ts, col = "gray", ylab = "Car Sales",
     main = "Car Sales - Moving Average Filtered")
lines(auto.ma.smooth.4year, col = "magenta")
lines(auto.ma.smooth.annual, col = "red")
lines(auto.ma.smooth.halfyear, col = "blue")
abline(lm(auto.ts~time(auto.ts)), lty = "dotted", col = "black")
```

```{r}
plot(decompose(auto.ts, type = "additive"))
```


## Establish Stationarity

### Seasonality Investigation

```{r}
# Create Function to make univariate scatterplot matrix of autocorrleation
lag.plot1=function(data1,max.lag=1,corr=TRUE,smooth=FALSE){ 
   name1=paste(deparse(substitute(data1)),"(t-",sep="")
   name2=paste(deparse(substitute(data1)),"(t)",sep="")
   data1=as.ts(data1)
   max.lag=as.integer(max.lag)
   prow=ceiling(sqrt(max.lag))
   pcol=ceiling(max.lag/prow)
   a=acf(data1,max.lag,plot=FALSE)$acf[-1]
  par(mfrow=c(prow,pcol), mar=c(2.5, 4, 2.5, 1), cex.main=1.1, font.main=1)
  for(h in 1:max.lag){                       
   plot(lag(data1,-h), data1, xy.labels=FALSE, main=paste(name1,h,")",sep=""), ylab=name2, xlab="") 
    if (smooth==TRUE) 
    lines(lowess(ts.intersect(lag(data1,-h),data1)[,1],
                 ts.intersect(lag(data1,-h),data1)[,2]), col="red")
    if (corr==TRUE)
    legend("topright", legend=round(a[h], digits=2), text.col ="blue", bg="white", x.intersp=0)
   }
}
```

```{r}
monthplot(unem.ts)
```

```{r}
lag.plot1(unem.ts,12,smooth=TRUE) 
```

```{r}
par(mfrow = c(2,1))
acf(unem.ts, lag.max = 61, main = ""); title("ACF Unemployment Rate")
pacf(unem.ts, lag.max = 61, main = ""); title("PACF Unemployment Rate")
```


(monthly plot shows higher values in the beginning and mid year)
(can difference it in SARIMA, if linear regression should use dummy for Jan Feb and Jun July)

(weak seasonality, but can still try to do seasonal difference)
(strongest correlation with first lag, then weaker with higher lags)

(acf slow decay, random walk or long memory process)
(some sign of seasonality -- note the local peak at lag 12, 24, 36, 48)

(pacf most significant at lag 1 can be AR(1))
(pacf also show sign at lag 12, 25,37,49 , can be a seasonal MA component)

```{r}
monthplot(auto.ts)
```

```{r}
lag.plot1(auto.ts,12,smooth=TRUE) 
```

```{r}
par(mfrow = c(2,1))
acf(auto.ts, lag.max = 61, main = ""); title("ACF Autosales")
pacf(auto.ts, lag.max = 61, main = ""); title("PACF Autosales")
```


(monthly plot shows more discrete values)
(seasonality is much stronger. clearly correlated with lag 12)
(should seasonal difference it)

(acf slow decay but show clearn local maximum at lag 12, 24, 36 , 48)

(pacf show sign at lag 1 and 12, AR(1) and SAR(1))