---
title: "Lab3 Q2"
author: "Michelle Kim, Sue Yang, Legg Yeung"
date: "August 2, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# copied
library(moments)
library(psych)
library(forecast)
library(tseries)

unem.data = read.csv("UNRATENSA.csv", header = T)
auto.data = read.csv("TOTALNSA.csv", header = T)
```

```{r}
unem.train = unem.data[0:816,]
unem.test = unem.data[817:834,]
```

```{r}
unem.train.ts = ts(unem.train$UNRATENSA)
unem.test.ts = ts(unem.test$UNRATENSA)
```


From the EDA, we speculated the following models:

  - Seasonal Differenced Series: SARIMA(4,0,1)(3,1,Q)
  - First Differenced Series: SARIMA(9,1,q)(1,0,1)
  - First and Seasonal Differenced Series: SARIMA(4,1,0)(0,1,1)

Because the EDA was inconclusive on differencing strategies, we define the following search spaces:

  - Seasonal Differenced Series: SARIMA(1:4,0,0:3)(0:4,1,0:3)
  - First Differenced Series: SARIMA(1:9,1,0:3)(0:3,0,0:3) 
  - First and Seasonal Differenced Series: SARIMA(0:5,1,0:3)(0:3,1,0:3)

where SARIMA(p,d,q)(P,D,Q)_12 is the general form of model.

```{r,eval = FALSE}
# Seasonal Differenced Series : SARIMA(1:4,0,0:3)(0:4,1,0:3)
bestAIC <- 10000 
unem.diff12.df = data.frame("p" = 0, "q" = 0, "P" = 0, "Q" = 0, "aic" = bestAIC)

for(p in 1:4){
  for (q in 0:3){
    for (P in 0:4){
      for (Q in 0:3){
        cat(p,q,P,Q,"\n")
        try(m <- Arima(unem.train.ts, order = c(p, 0, q), seasonal = list(order = c(P, 1, Q), period = 12)))
        
        if(m$aic < bestAIC) # update if this model attain better aic
        { bestAIC = m$aic
          bestFit = m
          bestModel = c( p, q, P, Q)
          cat(p,q,P,Q,as.numeric(bestAIC), "\n")
          unem.diff12.df = rbind(unem.diff12.df, 
                                 data.frame("p" = p, "q" = q, "P" = P, "Q" = Q, "aic" = bestAIC))} 
  
      }
    }
  }
}

write.csv(x = unem.diff12.df, file = "unem.diff12.df.csv")


# First Differenced Series: SARIMA(9,1,0:3)(0:3,0,0:3) 

bestAIC <- 10000 

unem.diff.df = data.frame("p" = 0, "q" = 0, "P" = 0, "Q" = 0, "aic" = bestAIC)

for(p in 1:9){
  for (q in 0:3){
    for (P in 0:3){
      for (Q in 0:3){
        cat(p,q,P,Q,"\n")
        try(m <- Arima(unem.train.ts, order = c(p, 1, q), seasonal = list(order = c(P, 0, Q), period = 12)),
            silent = TRUE)
        
        if(m$aic < bestAIC) # update if this model attain better aic
        { bestAIC = m$aic
        bestFit = m
        bestModel = c( p, q, P, Q)
        cat(p,q,P,Q,as.numeric(bestAIC), "\n")
        unem.diff.df = rbind(unem.diff.df, 
                               data.frame("p" = p, "q" = q, "P" = P, "Q" = Q, "aic" = bestAIC))} 
      }
    }
  }
}

write.csv(x = unem.diff.df, file = "unem.diff.df.csv")



# First and Seasonal Differenced Series: SARIMA(0:5,1,0:3)(0:3,1,0:3) 

bestAIC <- 10000 

unem.diff.diff12.df = data.frame("p" = 0, "q" = 0, "P" = 0, "Q" = 0, "aic" = bestAIC)

for(p in 0:5){
  for (q in 0:3){
    for (P in 0:3){
      for (Q in 0:3){
        cat(p,q,P,Q,"\n")
        try(m <- Arima(unem.train.ts, order = c(p, 1, q), seasonal = list(order = c(P, 1, Q), period = 12)),
            silent = TRUE)
        
        if(m$aic < bestAIC) # update if this model attain better aic
        { bestAIC = m$aic
        bestFit = m
        bestModel = c( p, q, P, Q)
        cat(p,q,P,Q,as.numeric(bestAIC), "\n")
        unem.diff.diff12.df = rbind(unem.diff.diff12.df, 
                             data.frame("p" = p, "q" = q, "P" = P, "Q" = Q, "aic" = bestAIC))} 
      }
    }
  }
}

write.csv(x = unem.diff.diff12.df, file = "unem.diff.diff12.df.csv")
```

```{r}
# Seasonal Differenced Results
unem.diff12.df = read.csv("unem.diff12.df.csv")
unem.diff12.df
```

```{r}
# First Differenced Results
unem.diff.df = read.csv("unem.diff.df.csv")
unem.diff.df
```

```{r}
# First and Seasonal Differenced Results
unem.diff.diff12.df = read.csv("unem.diff.diff12.df.csv")
unem.diff.diff12.df
```


```{r}
m <- Arima(unem.train.ts, order = c(4, 0, 3), seasonal = list(order = c(0, 1, 1), period = 12))
```

```{r}
m$aic
```

```{r}
par(mfrow = c(2,1))
acf(m$residuals)
pacf(m$residuals)
```





```{r}
tempframe = unem.diff12.df
```


```{r}
print_resid_chart <- function(ts, p, d, q, P, D, Q) {
  m <- Arima(ts, order = c(p, d, q), seasonal = list(order = c(P,D, Q), period = 12))
  print(m$aic)
  par(mfrow=c(3,1))
  hist(m$residuals)
  acf(m$residuals, 156)
  pacf(m$residuals, 156)
  return(m)
}
```

```{r}
m1 <- print_resid_chart(unem.train,2, 1, 1, 0, 1, 1)
m2 <- print_resid_chart(unem.train,3, 1, 1, 0, 1, 1)
m3 <- print_resid_chart(unem.train,2, 1, 3, 0, 1, 1)
```

